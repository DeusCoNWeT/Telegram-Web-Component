<!--
@license
@author Javier Caballero Abenza. All rights reserved.

Example:

    <telegram-wc></telegram-wc>

@element telegram-wc
@demo demo/index.html
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">

<link rel="import" href="bower_components/iron-icons/av-icons.html">

<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/paper-styles/shadow.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<script src="bower_components/moment/min/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="bower_components/telegram-api/dist/telegramApi.js"></script>

<dom-module id="telegram-wc">

  <template>

    <style is="custom-style" include="iron-flex iron-flex-alignment">
      :host{
        width: 400px;
        height: 400px;
        --telegram-background: #5682a3;
        overflow: hidden;
        position: relative;
        font: 14px/18px Tahoma,sans-serif,Arial,Helvetica;
        background-color: #e7ebf0;
        border: 1px solid #d2d2d2;
        border-radius:5px;
        /* vertical layout*/
        -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
        display: flex;
      }
      .container {
        overflow:auto;
      }
      :host[logged]{
        background-color:white;
      }
      .divisor {
        border:none;
        border-bottom:1px solid #d2d2d2;
        margin:0;
      }
      /* HEADER */
      paper-toolbar.toolbar{
        --paper-toolbar-background: var(--telegram-background);
        --paper-toolbar-title:{
          text-align: center;
          margin-left: auto;
          margin-right: auto;
          overflow: visible;
        }
      }
      .icon[icon="menu"] {
        width: 40px;
        height: 40px;
        margin-right: 25px;
      }
      paper-icon-button.icon{
        width: 40px;
        height: 40px;
      }
      /* CONTACTS VIEW */
      .contacts {
        padding:6px 12px;
        background-color:white;
        cursor:pointer;
      }
      .contacts:hover{
        background-color:#d2d2d2;
      }
      .contacts .name {
        margin:2px 0;
      }
      .contacts .chatPreview{
        font-size:12px;
        margin:0;
        color:#797979;
      }
      .profImg {
        height: 42px;
        width: 42px;
        border-radius:50%;
        margin-right:10px;
      }
      .profImg.small {
        height: 32px;
        width: 32px;
      }
      .emptyContacts{
        height: 100%;
      }
      ::-webkit-scrollbar-track
      {
        -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
        background-color: var(--paper-grey-200);
      }
      ::-webkit-scrollbar
      {
        width: 6px;
        background-color: var(--paper-grey-200);
      }
      ::-webkit-scrollbar-thumb
      {
        background-color: #42749b;
      }

      /* CHAT AREA */
      .chat{
        background: #ffffff;
        position:absolute;
        top:0;left:0;
        width: 100%;
        height: 100%;

      }
      .chat > .content {
        background-image: url('http://www.pinsho.com/wp-content/uploads/2013/11/telegram01.jpg');
        background-size: 100% 100%;
      }
      .displayArea{
        padding: 10px;
        height: calc(100% - 106px);
        overflow-y: scroll;
        overflow-x: hidden;
      }
      .messageIn, .messageOut{
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        max-width: 50%;
        font: 13px Roboto,arial,sans-serif;
        position: relative;
      }
      .messageIn{
        float: left;
        margin-right: 50%;
        background: white;
      }
      .messageIn:before{
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        border-bottom: 12px solid white;
        border-right: 21px solid transparent;
        border-left: 20px solid transparent;
        bottom: 0;
        left:-5px;
      }
      .messageOut{
        float: right;
        background-color:#DCF8C6;
        margin-left: 50%;
      }
      .messageOut:before{
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        border-bottom: 5px solid #DCF8C6;
        border-right: 3px solid transparent;
        border-left: 19px solid transparent;
        bottom: 0;
        right: -3px;
      }
      .date{
        font: 10px Roboto,arial,sans-serif;
        display: inherit;
        margin-bottom: 4px;
      }
      .sendArea{
        width: 100%;
        height: auto;
        border-top:1px solid #d2d2d2;
        background-color:white;
        max-width: 100%;
      }
      .input{
        font: 15px Roboto,arial,sans-serif;
        align-self: center;
        width: 100%;
        max-width: calc(100% - 36px);
      }
      .input > p {
        width: 100%;
        padding:8px;
        max-width: 100%;
        overflow:auto;
        max-height: 100px;
        word-wrap: break-word;
        word-break: break-all;
        margin:0;
      }
      .send{
        --paper-icon-button: {
          align-self: center;
          color: #42749b;
          width: 36px;
          height: 36px;
          padding:8px;
        };
        --paper-icon-button-disabled: {
          color:#333;
        };
      }
      .status{
        font-size:10px;
      }
      .groupicon{
        width: 20px;
        height: 20px;
        padding-bottom: 3px;
        margin-right: 2px;
      }
      /* Login menus */
      .login{
        padding:8px 16px;
        color: var(--paper-grey-700);
        font: 15px Roboto,arial,sans-serif;
        height: 100%;
        box-sizing: border-box;
        display: flex;
      }
      .loginMenu{
        padding: 0 18px 8px 18px;
        width: 100%;
        background-color:white; 
      }
      .loginMenu span{
        display: inline-table;    
      }
      .loginMenu input{
        width: 60%;
      }
      .inputContainer{
        position:relative;
      }
      .bold {
        font-weight: bold;
        text-transform: capitalize;
      }
      .subtitle {
        color: #999;
        margin: 15px 0 30px;
        font-size: 13px;
        line-height: 160%;
      }
      .code {
        margin:0 5px;
        width: 50px;
        height: 30px;
      }
      paper-input {
         --paper-input-container-input: {
          font-size: 13px;
        };
        --paper-input-container:{
          padding:0;
        }
      }
      .phoneContainer {
        margin-top:30px;
        font-size:13px;
      }
      .country-list{
        list-style:none;
        margin: 0;
        min-width: 100%;
        max-height: 100px;
        position: absolute;
        background-color:white;
        padding:0;
        top:50px;
        overflow:auto;
        z-index:1000;
        color: #42749b;
        @apply(--shadow-elevation-6dp);
      }
      .country-list > li {
        padding:8px 12px;
      }
      .country-list > li:hover {
        background-color: #f2f6fa;
      }
      .button {
        color: #42749b;
      }
      .loginMenu .button {
        margin-top:12px;
        float:right;
      }
      .loginMenu .button.sendcode {
        float: none;
      }
      .requireCode {
        text-align: center;
      }
      .requireCode [name="phoneCode"]{
        margin-top:60px;
      }
      .requireCode paper-button{
        margin-top:18px;
      }
      /* Search bar */
      #contactSearch {
        --paper-input-container-focus-color: #d2d2d2;
        --paper-input-container-input-color: #d2d2d2;
      }
      /* ANIMATIONS */
      .animated {
        -webkit-animation-duration: 0.3s;
        animation-duration: 0.3s;
        -webkit-animation-fill-mode: both;
        animation-fill-mode: both;
      }
      @-webkit-keyframes fadeInRight {
        from {
          opacity: 0;
          -webkit-transform: translate3d(100%, 0, 0);
          transform: translate3d(100%, 0, 0);
        }

        to {
          opacity: 1;
          -webkit-transform: none;
          transform: none;
        }
      }

      @keyframes fadeInRight {
        from {
          opacity: 0;
          -webkit-transform: translate3d(100%, 0, 0);
          transform: translate3d(100%, 0, 0);
        }

        to {
          opacity: 1;
          -webkit-transform: none;
          transform: none;
        }
      }

      .fadeInRight {
        -webkit-animation-name: fadeInRight;
        animation-name: fadeInRight;
      }
    </style>


<!-- Header -->
<paper-toolbar class="toolbar">
  <template is="dom-if" if="{{!logged}}">
    <img src="icon.png" class="icon"></img>
    <p>Telegram</p>
  </template>

  <template is="dom-if" if="{{logged}}">
    <paper-icon-button on-click="openMenu" class="icon" icon="menu"></paper-icon-button>
    <template is="dom-if" if="{{!searching}}">
      <p class="flex">Telegram</p>
    </template>
    <paper-input no-label-float class="flex self-center" hidden$="{{!searching}}" on-blur="checkCloseSearch" value="{{search_keywords}}"
      id="contactSearch"></paper-input>
    <template is="dom-if" if="{{!searching}}">
      <paper-icon-button icon="search" id="searchIcon" class="icon" on-click="searchContact"></paper-icon-button>
    </template>
  </template>

</paper-toolbar>
<div class="container flex">
  <!-- Login -->
  <template is="dom-if" if="{{!logged}}">
    <!-- Phone and code -->
    <div class="login" hidden="{{showCode}}">
      <div class="loginMenu vertical layout">
        <p class="bold">Register</p>
        <p class="subtitle">Please, select your country and introduce your phone number. You will receive a code of telegram app</p>
        <div class="inputContainer">
          <!-- Search country code -->
          <label for="country" class="subtitle">Country</label>
          <paper-input value="{{country}}" no-label-float focused="{{_openedSelector}}">
          </paper-input>
          <template is="dom-if" if="{{_openedSelector}}">
            <ul class="country-list" on-focus="_openSelector">
              <template is="dom-repeat" items="{{country_codes}}" filter="{{filterCountry(country)}}">
                <li on-mousedown="_selectCountry" tabindex="0">{{item.name}}</li>
              </template>
            </ul>
          </template>
          <!--  END search code-->
          <div class="phoneContainer horizontal layout ">
            <div>
              <label for="code" class="subtitle">Code</label>
              <paper-input name="code" value="{{countryCode}}" class="code" no-label-float>
                <div prefix>+</div>
              </paper-input>
            </div>
            <div class="flex">
              <label for="phonenumber" class="subtitle">Phone Number</label>
              <paper-input name="phonenumber" value="{{phone}}" class="phonenumber" id="phoneNumber" no-label-float tabindex="0"></paper-input>
            </div>
          </div>
          <paper-button on-click="sendCode" class="button">Send</paper-button>
        </div>
      </div>
    </div>
    <div class="login requireCode" hidden="{{!showCode}}">
      <div class="loginMenu">
        <p class="bold">+{{countryCode}} {{phone}}</p>
        <p class="subtitle flex">Enter the code you have received</p>
        <paper-input name="phoneCode" value="{{phoneCode}}" label="Insert your code here"></paper-input>
        <paper-button raised on-click="login" class="button sendcode">Send Code</paper-button>
      </div>
    </div>
  </template>

  <!-- Logged -->
  <template is="dom-if" if="{{logged}}">

    <!-- if Chat is closed -->
    <template is="dom-if" if="{{!selected}}">
      <template is="dom-if" if="{{!searching}}">
        <template is="dom-repeat" items="{{chats}}">
          <div class="contacts horizontal layout center" on-click="openChat">
            <img class="profImg" src="{{item.chat.photo}}">
            <div class="vertical layout displayName">
              <template is="dom-if" if="{{item.chat.user.title}}">
                <p class="name">
                  <iron-icon icon="supervisor-account" class="groupicon"></iron-icon>{{item.chat.user.title}}</p>
              </template>
              <template is="dom-if" if="{{item.chat.user.first_name}}">
                <p class="name">{{item.chat.user.first_name}} {{item.chat.user.last_name}}</p>
              </template>
              <p class="chatPreview">{{item.chat.chat_messages.0.text}}</p>
            </div>
          </div>
          <hr class="divisor">
        </template>
      </template>
      <template is="dom-if" if="{{searching}}">
        <template is="dom-repeat" items="{{contacts}}" filter="{{filterContact(search_keywords)}}" rendered-item-count="{{nContactsFound}}">
          <div class="contacts horizontal layout center" on-mousedown="loadContact">
            <template is="dom-if" if="{{item.image}}">
              <img class="profImg" src="{{item.image}}">
            </template>
            <template is="dom-if" if="{{!item.image}}">
              <img class="profImg" src="default.png">
            </template>
            <p>{{item.title}}{{item.first_name}} {{item.last_name}}</p>
          </div>
          <hr class="divisor">
        </template>
        <template is="dom-if" if="{{showNoContacts}}">
          <div class="vertical layout center-center emptyContacts">
            <p class="title">No results</p>
          </div>
        </template>
      </template>
      <template is="dom-if" if="{{chats_empty}}">
        <!-- TODO loading info -->
        <div class="vertical layout center-center emptyContacts">
          <p class="title">No results</p>
        </div>
      </template>
    </template>

    <!-- chat opened -->
    <template is="dom-if" if="{{user_selected}}">
      <div id="chatContainer" class="chat animated fadeInRight vertical layout">
        <paper-toolbar class="toolbar">
          <paper-icon-button on-click="closeChat" class="icon" icon="arrow-back"></paper-icon-button>
          <img class="profImg small" src="{{user_selected.photo}}">
          <div class="vertical layout">
            <template is="dom-if" if="{{user_selected.first_name}}">
              <span>{{user_selected.first_name}} {{user_selected.last_name}}</span>
            </template>
            <template is="dom-if" if="{{user_selected.title}}">
              <span><iron-icon icon="supervisor-account" class="groupicon"></iron-icon>{{user_selected.title}}</span>
            </template>
            <span class="status">{{_getStatus(user_selected.status)}}</span>
          </div>

        </paper-toolbar>
        <div class="content vertical layout flex">

          <div class="displayArea flex" id="displayArea">
            <template is="dom-repeat" items="[[user_selected.chat_messages]]">
              <template is="dom-if" if="{{item.mine}}">
                <div class="messageOut">
                  <span class="date">{{item.date}}</span>
                  <span>{{item.text}}</span>
                </div>
              </template>
              <template is="dom-if" if="{{!item.mine}}">
                <div class="messageIn">
                  <span class="date">{{item.date}}</span>
                  <span>{{item.text}}</span>
                </div>
              </template>
            </template>
          </div>

          <div class="sendArea horizontal layout">
            <div class="input flex horizontal layout">
              <p contenteditable="true" data-placeholder$="{{text_message==placeholder}}" class="flex" on-focus="removePlaceholder" on-blur="checkPlaceholder"
                on-keypress="updateTextMessage">{{placeholder}}</p>
            </div>
            <paper-icon-button icon="send" class="send" disabled="[[disable_send]]" on-click="sendMSG"></paper-icon-button>
          </div>

        </div>
      </div>
    </template>

  </template>

</div>
</template>
</dom-module>

<script>
  Polymer({

    is: 'telegram-wc',

    properties: {

      logged: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },

      showCode: {
        type: Boolean,
        value: false
      },

      searching: {
        type: Boolean,
        value: false
      },

      search_keywords: {
        type: String,
        value: ''
      },

      app: {
        type: Object,
        value: {
          id: 82261,
          hash: 'bb8cba71451932da9b62b7542ae27da2',
          version: '1.0.0'
        }
      },

      server: {
        type: Object,
        value: {
          test: [{
            id: 1,
            host: '149.154.175.10',
            port: 80
          }, {
            id: 2,
            host: '149.154.167.40',
            port: 80
          }, {
            id: 3,
            host: '149.154.175.117',
            port: 80
          }],
          production: [{
            id: 1,
            host: '149.154.175.50',
            port: 80
          }, {
            id: 2,
            host: '149.154.167.51',
            port: 80
          }, {
            id: 3,
            host: '149.154.175.100',
            port: 80
          }, {
            id: 4,
            host: '149.154.167.91',
            port: 80
          }, {
            id: 5,
            host: '149.154.171.5',
            port: 80
          }]
        },
      },
      chats: {
        type: Array,
        value: function () { return []; },
        notify: true,
      },
      chats_empty: {
        type: Boolean,
        computed: '_checkEmpty(chats.length)'
      },
      selected: {
        type: Boolean,
        value: false
      },
      text_message: {
        type: String,
        value: '',
        notify: true
      },
      placeholder: {
        type: String,
        value: 'Message'
      },
      disable_send: {
        type: Boolean,
        computed: '_isTextMessageEmpty(text_message)'
      },
      nContactsFound: {
        type: Boolean,
        observer: '_checkNContactsFound'
      },
      showNoContacts: {
        type: Boolean,
        value: true
      },
      _isPlaceholder: {
        type: Boolean,
        value: true
      },
      user_selected: {
        type: Object,
        notify: true
      }
    },
    // Observers
    _checkEmpty: function (chats) {
      return chats === 0;
    },
    _isTextMessageEmpty: function (message) {
      return !message;
    },
    _checkNContactsFound: function (newValue, oldValue) {
      this.set('showNoContacts', newValue == 0);
    },
    //Component lifecycle
    attached: function () {
      var _self = this;
      var url = this.resolveUrl('code.json');
      $.get(url, function (data) {
        _self.set('country_codes', data);
      });
      telegramApi.setConfig({
        app: this.app,
        server: this.server
      });
      // Extend telegram api
      telegramApi.getPhoto = function (type, photo) {
        var location = {
          _: "inputFileLocation",
          local_id: photo.local_id,
          secret: photo.secret,
          volume_id: photo.volume_id
        };
        var params = {
          dcID: photo.dc_id,
          fileDownload: true,
          singleInRequest: window.safari !== undefined,
          createNetworker: true
        };

        return telegramApi.invokeApi('upload.getFile', {
          location: location,
          offset: 0,
          limit: 524288
        }, params).then(function (result) {
          switch (type) {
            case 'byteArray':
              return result.bytes;
            case 'base64':
              return "data:image/jpeg;base64," + btoa(String.fromCharCode.apply(null, result.bytes));
            case 'blob':
              return new Blob([result.bytes], {
                type: 'image/jpeg'
              });
            default:
              return result.bytes;
          }
        });
      }
      this.getUser();

    },

    dettached: function () {
      this.logout();
    },

    //Component behaviour

    /*------------------------------------Authentication----------------------------*/

    login: function () {
      if (this.registered) this.signIn();
      else this.signUp();
    },

    logout: function () {
      telegramApi.logOut();
      this.logged = false;
      this.showCode = false;
      this.set('chats', []);
      this.chat = null;
      this.user = null;
    },

    sendCode: function () {
      if (!this.phone || !this.countryCode) return;

      var me = this;
      telegramApi.sendCode(this.countryCode + this.phone).then(
        function (sent_code) {
          me.codeHash = sent_code.phone_code_hash;
          me.registered = sent_code.phone_registered;
          me.showCode = true;
        },
        function (error) {

        }
      );
    },

    signIn: function () {
      if (!this.phone || !this.codeHash || !this.phoneCode || !this.countryCode) return;

      var me = this;
      telegramApi.signIn((this.countryCode + this.phone), this.codeHash, this.phoneCode).then(
        function (response) {
          // ls

          me.getUser();
        }
      );
    },

    signUp: function () {
      if (!this.phone || !this.codeHash || !this.phoneCode || !this.countryCode) return;

      var me = this;
      telegramApi.signUp((this.countryCode + this.phone), this.codeHash, this.phoneCode, this.user.firstname, this.user.lastname).then(
        function (response) {
          // Sign up complete
          this.getUser();
        }
      );
    },

    /*--------------------------------------User info-------------------------------------*/

    getUser: function () {
      var me = this;
      telegramApi.getUserInfo().then(
        function (user) {
          if (user.id) {
            //Logged
            me.set('user', user);
            me.logged = true;
            me.getContacts();
            me.getDialogs();
          }
        }
      );
    },

    getContacts: function () {
      var me = this;
      telegramApi.invokeApi('contacts.getContacts', {}).then(
        function (response) {
          // sort contacts by first name
          me.set('contacts', response.users.sort(function (contact1, contact2) {
            // avoid space
            var first_name1 = contact1.first_name.replace(" ", "");
            var first_name2 = contact2.first_name.replace(" ", "");

            if (first_name1 < first_name2) return -1;
            if (first_name1 > first_name2) return 1;
            return 0;
          }));
          for (var i = me.contacts.length - 1; i >= 0; i--) {
            me.getPhotoContact(me.contacts[i]);
          };
        }
      );
    },

    /* getDialogs(): 
        Obtains the user recent dialogs 
        and subscribes to receive notifications
    */
    getDialogs: function () {
      var me = this;
      telegramApi.getDialogs().then(
        function (response) {
          me.set('data', response.result);
          me.set('chats', []);
          var dialogs = response.result.dialogs;
          for (var i = 0; i < dialogs.length; i++) {
            // add to chats
            me.initializeChat(dialogs[i].peer);
            // subscribe modifications
            me.subscribe(dialogs[i].peer);
          };

        }
      );
    },

    /*----------------------------------Load component--------------------------------*/

    initializeChat: function (peer) {
      /* Object stored on array 'chats' show on sidebar:
        {
          - Chat:
              - chat_messages[] (chat history)
              - photo (String type image/jpeg)
              - user (user talking with)
              - participants (if group)
          - Peer:
              - _ (type of peer: peerUser, peerChannel, peerChat)
              - id (user_id, channel_id, chat_id)
        }
      */
      var chat = {};
      chat.user = this.searchUser(peer);
      var that = this;
      if (chat.user.first_name || chat.user.title) {
        this.getPhoto(chat, peer).then(function (chat) {
          // take chat messages
          that.getHistoryUser(chat.chat.user).then(function (response) {
            console.log(response);
            chat.chat.chat_messages = that.getMSGs(response.messages);
            // if group, add participants
            if (response.users.length > 0) {
              chat.participants = response.users;
            }
            that.push('chats', chat);
          },
            function (error) {
              console.err(error);
              this.push('chats', chat);
            })
        });
      }
    },

    getId: function (peer) {
      switch (peer._) {
        case 'peerUser':
          return peer.user_id;
          break
        case 'peerChannel':
          return peer.channel_id;
          break
        case 'peerChat':
          return peer.chat_id;
          break
      }
    },

    searchUser: function (peer) {
      var id = this.getId(peer);
      var found = false;
      for (var i = this.data.chats.length - 1; i >= 0 && !found; i--) {
        if (this.data.chats[i].id == id) {
          found = true;
          return this.data.chats[i]
        }
      }
      for (var i = this.data.users.length - 1; i >= 0 && !found; i--) {
        if (this.data.users[i].id == id) {
          found = true;
          return this.data.users[i];
        }
      };
    },
    // Return a promise with object {chat:chat,peer:peer}
    getPhoto: function (chat, peer) {
      return new Promise(function (resolve, reject) {
        if (!chat.user.photo || chat.user.photo._ == "chatPhotoEmpty") {
          chat.photo = this.resolveUrl('default.png');
          resolve({
            chat: chat,
            peer: peer
          });
          return;
        }

        var photo = chat.user.photo.photo_small;

        var me = this;
        telegramApi.getPhoto('base64', photo).then(
          function (result) {
            chat.photo = result;

            resolve({
              chat: chat,
              peer: peer
            });
          },
          function (error) {
            chat.photo = me.resolveUrl('default.png');
            resolve({
              chat: chat,
              peer: peer
            });
          }
        );
      }.bind(this));
    },

    getPhotoContact: function (user) {
      if (!user.photo) return;

      var photo = user.photo.photo_small;

      var me = this;
      telegramApi.getPhoto('base64', photo).then(
        function (result) {
          user.image = result;
        }
      );
    },
    /*---------------------------------Search methods-------------------------------*/

    searchContact: function () {
      this.searching = true;
      this.$$('#contactSearch').focus();
    },
    filterContact: function (keyword) {
      if (!keyword) {
        return null;
      } else {
        keyword = keyword.toLowerCase();
        return function (contact) {
          contact.title = contact.title || '';
          contact.first_name = contact.first_name || ' ';
          contact.last_name = contact.last_name || '';
          var full_name = (contact.title + ' ' + contact.first_name + ' ' + contact.last_name).toLowerCase();

          return (full_name.indexOf(keyword) != -1);
        };
      }
    },
    checkCloseSearch: function (e) {
      var isInput = e.currentTarget === this.$$('#contactSearch') && !e.detail;
      if (!this.search_keywords && !isInput) {
        this.searching = false;
      }
    },
    /*------------------------------------Load chat---------------------------------*/

    loadContact: function (e) {
      this.searching = false;
      this.search_keywords = '';
      var user = e.model.item;
      var exists = false;
      for (var i = this.chats.length - 1; i >= 0 && !exists; i--) {
        //If it exists
        if (this.chats[i].chat.user.id == user.id) {
          exists = true;
          var fakeEvent = { model: { item: this.chats[i], index: i } };
          this.loadChat(fakeEvent);
        }
      }
      if (!exists) {
        var chat = {
          messages: [],
          user: user,
          photo: user.image || this.resolveUrl('default.png')
        };
        var peer = {
          _: 'peerUser',
          user_id: user.id
        };
        this.push('chats', { chat: chat, peer: peer });
        // //Set selected style
        // var id = '#chatsTemplate';
        // var div = Polymer.dom(this.root).querySelectorAll(id)[0];
        // div.render();
        var fakeEvent = { model: { item: { chat: chat, peer: peer }, index: this.chats.length - 1 } };
        this.openChat(fakeEvent);
        this.subscribe(peer);
      }
    },
    /*----------------------------------Comunication methods-----------------------------*/

    sendMSG: function () {
      if (!this.text_message) return null;

      var me = this;
      telegramApi.sendMessage(this.getId(this.user_selected.peer), this.text_message).then(
        function (response) {
          me.getHistory();
        }
      );

      //Manual insert
      var msg = {};
      msg.message = this.text_message;
      msg.from_id = this.user.id;
      msg.date = new Date();
      this.addMSG(msg);
      // this.fixBottom();
    },

    subscribe: function (peer) {
      var id = this.getId(peer);
      var me = this;
      telegramApi.subscribe(id,
        function (response) {
          //Notifications callback
          if (response.updates || response.update) {
            var updates = response.updates || [response.update];
            for (var i = updates.length - 1; i >= 0; i--) {
              var update = updates[i]
              switch (update._) {
                case 'updateNewMessage':
                  //Identify target chat
                  var msg = update.message;
                  if (msg.from_id == me.user.id) {
                    var id = me.getId(msg.to_id);
                  } else {
                    var id = msg.from_id;
                  }
                  //If its the active chat refresh it
                  if (me.user_selected.id == id) {
                    me.getHistory();
                  } else {
                    //GIVE FEEDBACK TO USER ON CHAT LIST
                  }
                  break;

                case 'updateUserStatus':
                  me.refreshStatus(update.user_id, update.status);
                  break;
              }
            }
          }
          if (response._ == 'updateShortMessage') {
            if (response.user_id == me.user.id) {
              //unlucky: Cannot identify the chat if its an outbound message
            }
            //If its the active chat refresh it
            else if (me.user_selected.user.id == response.user_id) {
              me.getHistory();
            } else {
              //GIVE FEEDBACK TO USER ON CHAT LIST
            }
          }
        });
    },

    /*-------------------------------Refresh chat history-------------------------------*/

    getHistoryUser: function (user, cb) {
      return new Promise(function (resolve, reject) {
        if (user._ == 'user') {
          var type = 'user';
        } else {
          var type = 'chat';
        }
        var me = this;
        telegramApi.getHistory({
          id: user.id,
          take: 50,
          type: type
        }).then(resolve, reject);
      });
    },
    getHistory: function (user) {
      //Get messages
      var user = user || this.user_selected;
      if (user._ == 'user') {
        var type = 'user';
      } else {
        var type = 'chat';
      }

      var me = this;
      telegramApi.getHistory({
        id: user.id,
        take: 50,
        type: type
      }).then(function (data) {
        //Update view
        me.set('chat_messages', []);
        for (var i = data.messages.length - 1; i >= 0; i--) {

          me.addMSG(data.messages[i]);
        }
      });
    },
    getMSGs: function (msgs) {
      var messages = [];
      msgs.forEach(function (msg) {
        message = {};
        if (msg.from_id == this.user.id) {
          message.mine = true;
        } else {
          message.mine = false;
        }

        //Text
        message.text = msg.message;

        //Parse date
        var date = new Date(msg.date * 1000);
        message.date = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' ' +
          date.toLocaleTimeString();

        //Set id
        message.id = msg.id;
        messages.push(message);
      }.bind(this));
      return messages;
    },
    removeChat: function () {
      // stop pulling
      this.selected = false;
      this.set('chat_messages', []);
      this.set('user_selected', undefined);
    },

    refreshStatus: function (user_id, status) {
      var that = this;
      // chats
      this.chats.forEach(function (chat, index) {
        var user = chat.chat.user;
        if (user.id == user_id) {
          that.set('chats.' + index + '.chat.user.status', status);
        }
      });
      // contact
      this.contacts.forEach(function (contact, index) {
        if (contact.id == user_id) {
          that.set('contacts.' + index + '.status', status);
        }
      });
      // user_selected
      if (this.user_selected && this.user_selected.id == user_id) {
        that.set('user_selected.status', status);
      }
    },
    /*----------------------------------Display methods----------------------------------*/

    fixBottom: function () {
      //Fix scroll bar bottom
      var container = this.$$('#displayArea');
      if (container) {
        container.scrollTop = container.scrollHeight;
        if (container.scrollTop != container.scrollHeight) {
          var promise = new Promise(function (resolve, reject) {
            window.setTimeout(
              function () {
                resolve();
              }, 100);
          });
          /* DELAY */
          var me = this;
          promise.then(function () {
            container.scrollTop = container.scrollHeight;
          });
        }
      }
    },


    addMSG: function (msg) {
      //Check if exists
      for (var i = this.chat_messages.length - 1; i >= 0 && !exists; i--) {
        var exists = this.chat_messages[i].id == msg.id;
      }
      if (exists) return;

      //Check outbound or inbound message
      message = {};
      if (msg.from_id == this.user.id) {
        message.mine = true;
      } else {
        message.mine = false;
      }

      //Text
      message.text = msg.message;

      //Parse date
      var date = new Date(msg.date * 1000);
      message.date = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' ' +
        date.toLocaleTimeString();

      //Set id
      message.id = msg.id;

      this.push('chat_messages', message);

    },
    openChat: function (e) {
      this.set('user_selected', e.model.item.chat.user);
      this.set('user_selected.photo', e.model.item.chat.photo);
      this.set('user_selected.peer', e.model.item.peer);
      this.set('user_selected.chat_messages', e.model.item.chat.chat_messages);
      this.selected = true;
      var that = this;
      window.setTimeout(function(){that.fixBottom();},100);
      
    },
    closeChat: function () {
      this.removeChat();
    },
    /*--------------------------------List country callback-----------------------------*/
    _openSelector: function () {
      this._openedSelector = true;
    },
    _selectCountry: function (e) {
      var item = e.model.item;
      this.country = item.name;
      this.countryCode = item.number;
      this._openedSelector = false;
      this.$$('#phoneNumber').$.input.focus();
    },

    // Filter country
    filterCountry: function (country) {
      if (!country) {
        return null;
      }
      return function (item) {
        var name = item.name.toLowerCase()
        country = country.toLowerCase();
        return name.indexOf(country) != -1;
      }
    },
    /*----------------------------------Input text methods ----------------------------------*/
    removePlaceholder: function (e) {
      var target = e.currentTarget;
      var text = target.innerHTML;
      target.innerHTML = text === this.placeholder ? '' : text;
      this._isPlaceholder = false;
    },
    checkPlaceholder: function (e) {
      var target = e.currentTarget;
      target.innerHTML = target.innerHTML || this.placeholder;
      this._isPlaceholder = target.innerHTML == this.placeholder;
    },

    updateTextMessage: function (e) {
      var code = e.keyCode;
      var text = e.currentTarget.innerHTML + String.fromCharCode(code);
      this.text_message = text;
      if (code === 13) {
        // send message
        // Prevent navigator add <div>br</div>
        e.preventDefault();
        this.sendMSG();
        e.currentTarget.innerHTML = this.placeholder;
        e.currentTarget.blur();
        this.text_message = '';
      }
    },
    _getStatus: function (status) {
      var current_status = '';
      if (status) {
        if (status._ == 'userStatusOnline') {
          current_status = "Connected";
        } else if (status._ == 'userStatusRecently') {
          current_status = "last seen recently"
        } else {
          var time = status.was_online * 1000;
          var dif = new Date() - time;
          if (dif < 24 * 60 * 60 * 1000) {
            current_status = "last seen " + moment(time).fromNow();
          } else {
            current_status = "last seen " + moment(time).format('D MMM. YYYY');
          }
        }
      }
      return current_status;
    }
    /*---------------------------------- Left menu ----------------------------------*/
  });
</script>